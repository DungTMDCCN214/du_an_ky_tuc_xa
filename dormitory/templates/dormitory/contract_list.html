<!-- dormitory/templates/dormitory/contract_list.html -->
{% extends 'base.html' %}

{% block title %}Quáº£n lÃ½ Há»£p Ä‘á»“ng{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h1>ğŸ“„ Quáº£n lÃ½ Há»£p Ä‘á»“ng</h1>
    <a href="{% url 'contract_create' %}" class="btn btn-primary">â• ThÃªm Há»£p Ä‘á»“ng</a>
</div>

<!-- SEARCH BOX -->
<div class="card mb-4">
    <div class="card-body">
        <form method="get" class="row g-3 align-items-center">
            <div class="col-md-8">
                <div class="input-group">
                    <input type="text" name="search" class="form-control" 
                           placeholder="TÃ¬m kiáº¿m theo sá»‘ há»£p Ä‘á»“ng, mÃ£ SV, tÃªn SV, phÃ²ng..." 
                           value="{{ search_query }}">
                    <button type="submit" class="btn btn-primary">ğŸ” TÃ¬m kiáº¿m</button>
                </div>
            </div>
            <div class="col-md-4">
                {% if search_query %}
                <a href="{% url 'contract_list' %}" class="btn btn-outline-secondary">ğŸ”„ XÃ³a tÃ¬m kiáº¿m</a>
                {% endif %}
            </div>
        </form>
    </div>
</div>

<!-- Káº¾T QUáº¢ TÃŒM KIáº¾M -->
{% if search_query %}
<div class="alert alert-info mb-3">
    ğŸ” Káº¿t quáº£ tÃ¬m kiáº¿m cho: "<strong>{{ search_query }}</strong>"
    <span class="badge bg-primary ms-2">{{ page_obj.paginator.count }} káº¿t quáº£</span>
</div>
{% endif %}

<div class="card">
    <div class="card-header bg-light">
        <div class="d-flex justify-content-between align-items-center">
            <h5 class="mb-0">ğŸ“‹ Danh sÃ¡ch há»£p Ä‘á»“ng</h5>
            <span class="badge bg-secondary">
                Trang {{ page_obj.number }} â€¢ Tá»•ng: {{ page_obj.paginator.count }} há»£p Ä‘á»“ng
            </span>
        </div>
    </div>
    <div class="card-body">
        <div class="table-responsive">
            <table id="contractTable" class="table table-striped table-hover align-middle">
                <thead class="table-dark">
                <tr>
                    <th>Sá»‘ há»£p Ä‘á»“ng</th>
                    <th>Sinh viÃªn</th>
                    <th>PhÃ²ng</th>
                    <th>NgÃ y báº¯t Ä‘áº§u</th>
                    <th>NgÃ y káº¿t thÃºc</th>
                    <th>Tiá»n cá»c</th>
                    <th>Tráº¡ng thÃ¡i</th>
                    <th>Thao tÃ¡c</th>
                </tr>
                <!-- HÃ€NG FILTER -->
                <tr class="bg-light">
                    <th><input type="text" class="form-control form-control-sm column-filter" placeholder="TÃ¬m sá»‘ HÄ..."></th>
                    <th><input type="text" class="form-control form-control-sm column-filter" placeholder="TÃ¬m SV..."></th>
                    <th><input type="text" class="form-control form-control-sm column-filter" placeholder="TÃ¬m phÃ²ng..."></th>
                    <th><input type="text" class="form-control form-control-sm column-filter" placeholder="dd/mm/yyyy"></th>
                    <th><input type="text" class="form-control form-control-sm column-filter" placeholder="dd/mm/yyyy"></th>
                    <th><input type="text" class="form-control form-control-sm column-filter" placeholder="VNÄ"></th>
                    <th>
                    <select class="form-select form-select-sm column-filter">
                        <option value="">Táº¥t cáº£</option>
                        <option value="Äang hoáº¡t Ä‘á»™ng">Äang hoáº¡t Ä‘á»™ng</option>
                        <option value="ÄÃ£ háº¿t háº¡n">ÄÃ£ háº¿t háº¡n</option>
                        <option value="ÄÃ£ cháº¥m dá»©t">ÄÃ£ cháº¥m dá»©t</option>
                    </select>
                    </th>
                    <th></th>
                </tr>
                </thead>
                <tbody>
                {% for contract in page_obj %}
                <tr>
                    <td>{{ contract.contract_number }}</td>
                    <td>
                    {{ contract.student.student_id }} - 
                    {% if contract.student.full_name %}
                        {{ contract.student.full_name }}
                    {% else %}
                        {{ contract.student.user.get_full_name }}
                    {% endif %}
                    </td>
                    <td>{{ contract.room.building.name }} - P.{{ contract.room.room_number }}</td>
                    <td>{{ contract.start_date|date:"d/m/Y" }}</td>
                    <td>{{ contract.end_date|date:"d/m/Y" }}</td>
                    <td>{{ contract.deposit|floatformat:0 }} VNÄ</td>
                    <td>
                    <span class="badge 
                        {% if contract.status == 'active' %}bg-success
                        {% elif contract.status == 'expired' %}bg-danger
                        {% else %}bg-warning text-dark{% endif %}">
                        {{ contract.get_status_display }}
                    </span>
                    </td>
                    <td>
                    <a href="{% url 'contract_edit' contract.pk %}" class="btn btn-sm btn-outline-primary">âœï¸</a>
                    <a href="{% url 'contract_delete' contract.pk %}" class="btn btn-sm btn-outline-danger">ğŸ—‘ï¸</a>
                    </td>
                </tr>
                {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- PHÃ‚N TRANG -->
{% if page_obj.paginator.num_pages > 1 %}
<nav aria-label="Page navigation" class="mt-4">
    <ul class="pagination justify-content-center">
        {% if page_obj.has_previous %}
            <li class="page-item">
                <a class="page-link" href="?page=1{% if search_query %}&search={{ search_query }}{% endif %}">Â« Äáº§u</a>
            </li>
            <li class="page-item">
                <a class="page-link" href="?page={{ page_obj.previous_page_number }}{% if search_query %}&search={{ search_query }}{% endif %}">â€¹ TrÆ°á»›c</a>
            </li>
        {% endif %}

        {% for num in page_obj.paginator.page_range %}
            {% if page_obj.number == num %}
                <li class="page-item active">
                    <span class="page-link">{{ num }}</span>
                </li>
            {% elif num > page_obj.number|add:'-3' and num < page_obj.number|add:'3' %}
                <li class="page-item">
                    <a class="page-link" href="?page={{ num }}{% if search_query %}&search={{ search_query }}{% endif %}">{{ num }}</a>
                </li>
            {% endif %}
        {% endfor %}

        {% if page_obj.has_next %}
            <li class="page-item">
                <a class="page-link" href="?page={{ page_obj.next_page_number }}{% if search_query %}&search={{ search_query }}{% endif %}">Tiáº¿p â€º</a>
            </li>
            <li class="page-item">
                <a class="page-link" href="?page={{ page_obj.paginator.num_pages }}{% if search_query %}&search={{ search_query }}{% endif %}">Cuá»‘i Â»</a>
            </li>
        {% endif %}
    </ul>
</nav>

<!-- THÃ”NG TIN TRANG -->
<div class="text-center text-muted mt-2">
    Trang {{ page_obj.number }} / {{ page_obj.paginator.num_pages }} 
    â€¢ {{ page_obj.paginator.count }} káº¿t quáº£
</div>
{% endif %}

<link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/dataTables.bootstrap5.min.css">
<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.13.6/js/dataTables.bootstrap5.min.js"></script>

<script>
$(function() {
  const table = $('#contractTable').DataTable({
    dom: '',  
    orderCellsTop: true,
    fixedHeader: true,
    language: {
        zeroRecords: "KhÃ´ng tÃ¬m tháº¥y dá»¯ liá»‡u phÃ¹ há»£p"
    },
    pageLength: 10
});

  const origThead = $('#contractTable').find('thead').first();

  if (!origThead.data('filters-populated')) {
    origThead.find('tr').eq(1).find('th').each(function(colIndex) {
      const $th = $(this);
      const $select = $th.find('select');

      if ($select.length) {
        $select.find('option').not(':first').remove();
        const values = new Set();
        table.column(colIndex).data().each(function(cellValue) {
          const text = $('<div>').html(cellValue).text().trim();
          if (text) values.add(text);
        });
        const sorted = Array.from(values).sort((a,b) => a.localeCompare(b, 'vi'));
        sorted.forEach(v => {
          const escaped = $('<div>').text(v).html();
          $select.append(`<option value="${escaped}">${escaped}</option>`);
        });
        $select.data('populated', true);
      }
    });
    origThead.data('filters-populated', true);
  }

  origThead.on('keyup change', '.column-filter', function() {
    const colIndex = $(this).closest('th').index();
    const val = $(this).val();
    table.column(colIndex).search(val, true, false).draw();
  });

  $('#resetFilters').on('click', function() {
    origThead.find('.column-filter').each(function() {
      $(this).val('');
      const colIndex = $(this).closest('th').index();
      table.column(colIndex).search('');
    });
    table.search('').draw(); 
    table.draw();
  });
});
</script>

{% endblock %}