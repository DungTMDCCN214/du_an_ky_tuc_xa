<!-- dormitory/templates/dormitory/contract_list.html -->
{% extends 'base.html' %}

{% block title %}Quản lý Hợp đồng{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h1>📄 Quản lý Hợp đồng</h1>
    <a href="{% url 'contract_create' %}" class="btn btn-primary">➕ Thêm Hợp đồng</a>
</div>

<!-- SEARCH BOX -->
<div class="card mb-4">
    <div class="card-body">
        <form method="get" class="row g-3 align-items-center">
            <div class="col-md-8">
                <div class="input-group">
                    <input type="text" name="search" class="form-control" 
                           placeholder="Tìm kiếm theo số hợp đồng, mã SV, tên SV, phòng..." 
                           value="{{ search_query }}">
                    <button type="submit" class="btn btn-primary">🔍 Tìm kiếm</button>
                </div>
            </div>
            <div class="col-md-4">
                {% if search_query %}
                <a href="{% url 'contract_list' %}" class="btn btn-outline-secondary">🔄 Xóa tìm kiếm</a>
                {% endif %}
            </div>
        </form>
    </div>
</div>

<!-- KẾT QUẢ TÌM KIẾM -->
{% if search_query %}
<div class="alert alert-info mb-3">
    🔍 Kết quả tìm kiếm cho: "<strong>{{ search_query }}</strong>"
    <span class="badge bg-primary ms-2">{{ page_obj.paginator.count }} kết quả</span>
</div>
{% endif %}

<div class="card">
    <div class="card-header bg-light">
        <div class="d-flex justify-content-between align-items-center">
            <h5 class="mb-0">📋 Danh sách hợp đồng</h5>
            <span class="badge bg-secondary">
                Trang {{ page_obj.number }} • Tổng: {{ page_obj.paginator.count }} hợp đồng
            </span>
        </div>
    </div>
    <div class="card-body">
        <div class="table-responsive">
            <table id="contractTable" class="table table-striped table-hover align-middle">
                <thead class="table-dark">
                <tr>
                    <th>Số hợp đồng</th>
                    <th>Sinh viên</th>
                    <th>Phòng</th>
                    <th>Ngày bắt đầu</th>
                    <th>Ngày kết thúc</th>
                    <th>Tiền cọc</th>
                    <th>Trạng thái</th>
                    <th>Thao tác</th>
                </tr>
                <!-- HÀNG FILTER -->
                <tr class="bg-light">
                    <th><input type="text" class="form-control form-control-sm column-filter" placeholder="Tìm số HĐ..."></th>
                    <th><input type="text" class="form-control form-control-sm column-filter" placeholder="Tìm SV..."></th>
                    <th><input type="text" class="form-control form-control-sm column-filter" placeholder="Tìm phòng..."></th>
                    <th><input type="text" class="form-control form-control-sm column-filter" placeholder="dd/mm/yyyy"></th>
                    <th><input type="text" class="form-control form-control-sm column-filter" placeholder="dd/mm/yyyy"></th>
                    <th><input type="text" class="form-control form-control-sm column-filter" placeholder="VNĐ"></th>
                    <th>
                    <select class="form-select form-select-sm column-filter">
                        <option value="">Tất cả</option>
                        <option value="Đang hoạt động">Đang hoạt động</option>
                        <option value="Đã hết hạn">Đã hết hạn</option>
                        <option value="Đã chấm dứt">Đã chấm dứt</option>
                    </select>
                    </th>
                    <th></th>
                </tr>
                </thead>
                <tbody>
                {% for contract in page_obj %}
                <tr>
                    <td>{{ contract.contract_number }}</td>
                    <td>
                    {{ contract.student.student_id }} - 
                    {% if contract.student.full_name %}
                        {{ contract.student.full_name }}
                    {% else %}
                        {{ contract.student.user.get_full_name }}
                    {% endif %}
                    </td>
                    <td>{{ contract.room.building.name }} - P.{{ contract.room.room_number }}</td>
                    <td>{{ contract.start_date|date:"d/m/Y" }}</td>
                    <td>{{ contract.end_date|date:"d/m/Y" }}</td>
                    <td>{{ contract.deposit|floatformat:0 }} VNĐ</td>
                    <td>
                    <span class="badge 
                        {% if contract.status == 'active' %}bg-success
                        {% elif contract.status == 'expired' %}bg-danger
                        {% else %}bg-warning text-dark{% endif %}">
                        {{ contract.get_status_display }}
                    </span>
                    </td>
                    <td>
                    <a href="{% url 'contract_edit' contract.pk %}" class="btn btn-sm btn-outline-primary">✏️</a>
                    <a href="{% url 'contract_delete' contract.pk %}" class="btn btn-sm btn-outline-danger">🗑️</a>
                    </td>
                </tr>
                {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- PHÂN TRANG -->
{% if page_obj.paginator.num_pages > 1 %}
<nav aria-label="Page navigation" class="mt-4">
    <ul class="pagination justify-content-center">
        {% if page_obj.has_previous %}
            <li class="page-item">
                <a class="page-link" href="?page=1{% if search_query %}&search={{ search_query }}{% endif %}">« Đầu</a>
            </li>
            <li class="page-item">
                <a class="page-link" href="?page={{ page_obj.previous_page_number }}{% if search_query %}&search={{ search_query }}{% endif %}">‹ Trước</a>
            </li>
        {% endif %}

        {% for num in page_obj.paginator.page_range %}
            {% if page_obj.number == num %}
                <li class="page-item active">
                    <span class="page-link">{{ num }}</span>
                </li>
            {% elif num > page_obj.number|add:'-3' and num < page_obj.number|add:'3' %}
                <li class="page-item">
                    <a class="page-link" href="?page={{ num }}{% if search_query %}&search={{ search_query }}{% endif %}">{{ num }}</a>
                </li>
            {% endif %}
        {% endfor %}

        {% if page_obj.has_next %}
            <li class="page-item">
                <a class="page-link" href="?page={{ page_obj.next_page_number }}{% if search_query %}&search={{ search_query }}{% endif %}">Tiếp ›</a>
            </li>
            <li class="page-item">
                <a class="page-link" href="?page={{ page_obj.paginator.num_pages }}{% if search_query %}&search={{ search_query }}{% endif %}">Cuối »</a>
            </li>
        {% endif %}
    </ul>
</nav>

<!-- THÔNG TIN TRANG -->
<div class="text-center text-muted mt-2">
    Trang {{ page_obj.number }} / {{ page_obj.paginator.num_pages }} 
    • {{ page_obj.paginator.count }} kết quả
</div>
{% endif %}

<link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/dataTables.bootstrap5.min.css">
<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.13.6/js/dataTables.bootstrap5.min.js"></script>

<script>
$(function() {
  const table = $('#contractTable').DataTable({
    dom: '',  
    orderCellsTop: true,
    fixedHeader: true,
    language: {
        zeroRecords: "Không tìm thấy dữ liệu phù hợp"
    },
    pageLength: 10
});

  const origThead = $('#contractTable').find('thead').first();

  if (!origThead.data('filters-populated')) {
    origThead.find('tr').eq(1).find('th').each(function(colIndex) {
      const $th = $(this);
      const $select = $th.find('select');

      if ($select.length) {
        $select.find('option').not(':first').remove();
        const values = new Set();
        table.column(colIndex).data().each(function(cellValue) {
          const text = $('<div>').html(cellValue).text().trim();
          if (text) values.add(text);
        });
        const sorted = Array.from(values).sort((a,b) => a.localeCompare(b, 'vi'));
        sorted.forEach(v => {
          const escaped = $('<div>').text(v).html();
          $select.append(`<option value="${escaped}">${escaped}</option>`);
        });
        $select.data('populated', true);
      }
    });
    origThead.data('filters-populated', true);
  }

  origThead.on('keyup change', '.column-filter', function() {
    const colIndex = $(this).closest('th').index();
    const val = $(this).val();
    table.column(colIndex).search(val, true, false).draw();
  });

  $('#resetFilters').on('click', function() {
    origThead.find('.column-filter').each(function() {
      $(this).val('');
      const colIndex = $(this).closest('th').index();
      table.column(colIndex).search('');
    });
    table.search('').draw(); 
    table.draw();
  });
});
</script>

{% endblock %}