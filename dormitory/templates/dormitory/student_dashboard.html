{% extends 'base.html' %}
{% block title %}Dashboard Sinh Vi√™n{% endblock %}
{% block content %}
<div class="container">
    <div class="row">
        <div class="col-md-12">
            <h2>üéì Dashboard Sinh Vi√™n</h2>

            <!-- Th√¥ng b√°o -->
            {% if messages %}
                {% for message in messages %}
                <div class="alert alert-{{ message.tags }} alert-dismissible fade show">
                    {{ message }}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
                {% endfor %}
            {% endif %}

            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">Xin ch√†o, {{ user.username }}!</h5>

                    <!-- Th√¥ng tin sinh vi√™n -->
                    {% if student %}
                    <div class="row mb-4">
                        <div class="col-md-6">
                            <p><strong>M√£ SV:</strong> {{ student.student_id }}</p>
                            <p><strong>Tr∆∞·ªùng:</strong> {{ student.university }}</p>
                            <p><strong>Khoa:</strong> {{ student.faculty }}</p>
                        </div>
                        <div class="col-md-6">
                            <p><strong>Kh√≥a:</strong> {{ student.course }}</p>
                            <p><strong>H·ªç t√™n:</strong> {{ student.full_name|default:user.get_full_name }}</p>
                            <p><strong>Email:</strong> {{ user.email }}</p>
                        </div>
                    </div>
                    {% else %}
                    <div class="alert alert-warning">
                        <h6>‚ö†Ô∏è CH∆ØA HO√ÄN THI·ªÜN H·ªí S∆†</h6>
                        <p>Vui l√≤ng ho√†n thi·ªán th√¥ng tin sinh vi√™n ƒë·ªÉ s·ª≠ d·ª•ng ƒë·∫ßy ƒë·ªß t√≠nh nƒÉng.</p>
                        <a href="{% url 'complete_profile' %}" class="btn btn-warning btn-sm">Ho√†n thi·ªán h·ªì s∆°</a>
                    </div>
                    {% endif %}

                    <!-- H·ª£p ƒë·ªìng hi·ªán t·∫°i -->
                    {% if current_contract %}
                    <div class="alert alert-success">
                        <h6>‚úÖ H·ª¢P ƒê·ªíNG HI·ªÜN T·∫†I</h6>
                        <p><strong>Ph√≤ng:</strong> {{ current_contract.room.room_number }} - {{ current_contract.room.building.name }}</p>
                        <p><strong>Lo·∫°i ph√≤ng:</strong> {{ current_contract.room.room_type.name }}</p>
                        <p><strong>Ng√†y b·∫Øt ƒë·∫ßu:</strong> {{ current_contract.start_date }}</p>
                        <p><strong>Ng√†y k·∫øt th√∫c:</strong> {{ current_contract.end_date }}</p>
                        <p><strong>Ti·ªÅn c·ªçc:</strong> {{ current_contract.deposit|floatformat:0 }} VNƒê</p>
                        <p><strong>Tr·∫°ng th√°i:</strong> <span class="badge bg-success">{{ current_contract.get_status_display }}</span></p>
                    </div>
                    {% else %}
                    <div class="alert alert-warning">
                        <h6>‚ö†Ô∏è CH∆ØA C√ì H·ª¢P ƒê·ªíNG</h6>
                        <p>B·∫°n ch∆∞a c√≥ h·ª£p ƒë·ªìng ph√≤ng n√†o. H√£y ƒëƒÉng k√Ω ph√≤ng ngay!</p>
                    </div>
                    {% endif %}

                    <!-- Menu ch·ª©c nƒÉng -->
                    <div class="row mt-4">
                        <div class="col-md-3">
                            <div class="card text-white bg-primary mb-3">
                                <div class="card-body text-center">
                                    <h5 class="card-title">üè† Ph√≤ng Tr·ªëng</h5>
                                    <p class="card-text">ƒêƒÉng k√Ω ph√≤ng m·ªõi</p>
                                    <a href="#available-rooms" class="btn btn-light btn-sm">Xem ngay</a>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card text-white bg-success mb-3">
                                <div class="card-body text-center">
                                    <h5 class="card-title">üìÑ H·ª£p ƒë·ªìng</h5>
                                    <p class="card-text">Th√¥ng tin h·ª£p ƒë·ªìng</p>
                                    {% if current_contract %}
                                    <a href="#" class="btn btn-light btn-sm">Chi ti·∫øt</a>
                                    {% else %}
                                    <button class="btn btn-light btn-sm" disabled>Chi ti·∫øt</button>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card text-white bg-info mb-3">
                                <div class="card-body text-center">
                                    <h5 class="card-title">üí∞ Thanh to√°n</h5>
                                    <p class="card-text">Thanh to√°n tr·ª±c tuy·∫øn</p>
                                    {% if current_contract %}
                                    <a href="{% url 'student_payments' %}" class="btn btn-light btn-sm">Thanh to√°n ngay</a>
                                    {% else %}
                                    <button class="btn btn-light btn-sm" disabled>Ch∆∞a c√≥ Hƒê</button>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card text-white bg-warning mb-3">
                                <div class="card-body text-center">
                                    <h5 class="card-title">üë§ H·ªì s∆°</h5>
                                    <p class="card-text">C·∫≠p nh·∫≠t th√¥ng tin</p>
                                    <a href="{% url 'complete_profile' %}" class="btn btn-light btn-sm">Ch·ªânh s·ª≠a</a>
                                </div>
                            </div>
                        </div>
                        <!-- Trong ph·∫ßn menu c·ªßa sinh vi√™n -->
                        <div class="col-md-3">
                            <div class="card text-white bg-info mb-3">
                                <div class="card-body text-center">
                                    <h5 class="card-title">üõ†Ô∏è Y√™u c·∫ßu S·ª≠a ch·ªØa</h5>
                                    <p class="card-text">G·ª≠i v√† theo d√µi y√™u c·∫ßu</p>
                                    <a href="{% url 'student_repairs' %}" class="btn btn-light btn-sm">Qu·∫£n l√Ω</a>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Danh s√°ch ph√≤ng tr·ªëng -->
                    <div id="available-rooms" class="mt-5">
                        <h4>üè† Ph√≤ng Tr·ªëng Hi·ªán C√≥</h4>
                        
                        {% if not student %}
                        <div class="alert alert-danger">
                            <strong>Vui l√≤ng ho√†n thi·ªán h·ªì s∆° sinh vi√™n tr∆∞·ªõc khi ƒëƒÉng k√Ω ph√≤ng!</strong>
                        </div>
                        {% elif available_rooms %}
                        <div class="row">
                            {% for room in available_rooms %}
                            <div class="col-md-4 mb-3">
                                <div class="card h-100">
                                    <div class="card-header bg-light">
                                        <h6 class="card-title mb-0">Ph√≤ng {{ room.room_number }}</h6>
                                    </div>
                                    <div class="card-body">
                                        <p class="card-text small">
                                            <strong>üè¢ T√≤a:</strong> {{ room.building.name }}<br>
                                            <strong>üì¶ Lo·∫°i:</strong> {{ room.room_type.name }}<br>
                                            <strong>üë• S·ª©c ch·ª©a:</strong> {{ room.room_type.capacity }} ng∆∞·ªùi<br>
                                            <strong>üõèÔ∏è ƒêang ·ªü:</strong> {{ room.current_occupancy }} ng∆∞·ªùi<br>
                                            <strong>‚úÖ C√≤n tr·ªëng:</strong> 
                                                {% if room.current_occupancy < room.room_type.capacity %}
                                                <span class="text-success fw-bold">{{ room.get_available_slots }} ch·ªó</span>
                                                {% else %}
                                                <span class="text-danger">ƒê√£ ƒë·∫ßy</span>
                                                {% endif %}
                                            <br>
                                            <strong>üí∞ Gi√°:</strong> <span class="text-primary fw-bold">{{ room.room_type.price_per_month|floatformat:0 }} VNƒê/th√°ng</span><br>
                                            <strong>üèóÔ∏è T·∫ßng:</strong> {{ room.floor }}
                                        </p>
                                    </div>
                                    <div class="card-footer bg-white">
                                        {% if not student %}
                                            <button class="btn btn-secondary btn-sm w-100" disabled>Ho√†n thi·ªán h·ªì s∆°</button>
                                        {% elif current_contract %}
                                            <button class="btn btn-secondary btn-sm w-100" disabled>ƒê√£ c√≥ ph√≤ng</button>
                                        {% elif room.current_occupancy >= room.room_type.capacity %}
                                            <button class="btn btn-danger btn-sm w-100" disabled>ƒê√£ ƒë·∫ßy</button>
                                        {% else %}
                                            <a href="{% url 'room_booking' room.id %}" class="btn btn-primary btn-sm w-100">ƒêƒÉng k√Ω ngay</a>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                        {% else %}
                        <div class="alert alert-info">
                            <strong>Hi·ªán kh√¥ng c√≥ ph√≤ng tr·ªëng n√†o.</strong> Vui l√≤ng quay l·∫°i sau.
                        </div>
                        {% endif %}
                    </div>

                    <!-- Th·ªëng k√™ c√° nh√¢n -->
                    {% if current_contract %}
                    <div class="row mt-5">
                        <div class="col-md-12">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <h4>üìä Th·ªëng k√™ C√° nh√¢n</h4>
                                <a href="{% url 'student_payments' %}" class="btn btn-warning">
                                    <i class="fas fa-credit-card"></i> Thanh To√°n Tr·ª±c Tuy·∫øn
                                </a>
                            </div>
                            <div class="row">
                                <div class="col-md-3">
                                    <div class="card text-white bg-primary">
                                        <div class="card-body text-center">
                                            <h5 class="card-title">{{ current_contract.room.room_type.price_per_month|floatformat:0 }}</h5>
                                            <p class="card-text">VNƒê/th√°ng</p>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="card text-white bg-success">
                                        <div class="card-body text-center">
                                            <h5 class="card-title">{{ current_contract.deposit|floatformat:0 }}</h5>
                                            <p class="card-text">Ti·ªÅn c·ªçc</p>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="card text-white bg-info">
                                        <div class="card-body text-center">
                                            <h5 class="card-title">{{ current_contract.room.current_occupancy }}/{{ current_contract.room.room_type.capacity }}</h5>
                                            <p class="card-text">S·ªë ng∆∞·ªùi trong ph√≤ng</p>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="card text-white bg-warning">
                                        <div class="card-body text-center">
                                            <h5 class="card-title">{% now "d/m/Y" %}</h5>
                                            <p class="card-text">H√¥m nay</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}